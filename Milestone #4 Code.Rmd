---
title: "Milestone #4"
author: "Group 22: Jaemie Anne Abad, Vig Karthik, Kathy LeBert"
date: "2023-11-20"
output: html_document
---

## Introduction

Our project continues with the two Cal Enviro Screen (CES) datasets from 2021 ("scores" and "measures") and the California Health and Human Services (CHHS) asthma emergency department (ED) visit rates dataset from 2020.

## Milestone #2 Summary

As a summary of what was accomplished in Milestone #2, we imported the three datasets into R, renamed the column names for ease of analysis, and identified some variables of interest to use in our analysis. We ran summary statistics in our initial exploration of the data. The datasets contain rows of observations by census tract, which are further categorized into counties. While this level of granularity in location is appreciated, our team wishes to match asthma ED visit rates with the CES scores. The asthma ED visit rates are only at the county level, leading to the need to aggregate census tracts into the county level to match up the datasets for further analysis.

```{r clean_up_columns - Vig, include=FALSE}

# update.packages()

library(data.table)
library(readxl)
library(tidyverse)

#loading the data.table library to read in the csv
#also loaded read_xl to read the xlsx file

data_dictionary <- read_xlsx("calenviroscreen_datadictionary.xlsx")
#using read_xlsx to read in the data dictionary

measures_raw <- fread("calenviroscreen_measures_2021.csv", encoding = "UTF-8")
#using fread() from the data.table package to read the measures csv.
#using fread() so special characters read in properly

scores_raw <- fread("calenviroscreen_scores_demog_2021.csv", encoding = "UTF-8")
#using fread() to read the demographics csv

asthma_raw <- fread("chhs_asthma_ed.csv")
#using fread() to read the asthma csv.

#now that we've read the files, I've went into the csv files and removed 
#periods by some abbreviations to avoid '._' string chunks in columns
#this is mostly for aesthetic and typing ease during the project

#the below functions take the raw csvs and convert all columns to lowercase
#they also remove spaces in the column names to convert columns to snakecase

measures <- rename_with(
  measures_raw,             # data frame
  ~ tolower(           # function call (using tolower())
    gsub(" ",          # embedded gsub() checking for empty spaces pattern " "
         "_",          # replace pattern with underscore "_"         
         .x,           
         fixed = TRUE) 
    ))

scores <- rename_with(
  scores_raw,             # data frame
  ~ tolower(           # function call (using tolower())
    gsub(" ",          # embedded gsub() checking for empty spaces pattern " "
         "_",          # replace pattern with underscore "_"         
         .x,           
         fixed = TRUE) 
    ))


asthma <- rename_with(
  asthma_raw,             # data frame
  ~ tolower(           # function call (using tolower())
    gsub(" ",          # embedded gsub() checking for empty spaces pattern " "
         "_",         # replace pattern with underscore "_"          
         .x,           
         fixed = TRUE) 
    ))

#str(measures)
#str(scores)
#str(asthma)

#I checked the dataframe structure to see if we needed to change column types.
#The column types seem to be accurately assigned. Based on the column
#descriptors, there seems to be no mismatch of data types. Characters are
#characters, integers are integers, and decimals are numbers.

```

```{r data_element_analysis - Jaemie, include=FALSE}

# # 1 - CES County
# # lists which of CA's 58 counties is specified
# class(measures$california_county)
# 
# # 2 - CES Asthma
# class(measures$asthma)
# summary(measures$asthma)
# class(measures$asthma_pctl)
# summary(measures$asthma_pctl)
# 
# # 3 - CES Score
# class(scores$ces_4.0_score)
# summary(scores$ces_4.0_score)
# class(scores$ces_4.0_percentile)
# summary(scores$ces_4.0_percentile)
# 
# # 4 - CES Age
# class(scores$children_below_10_years_prct)
# summary(scores$children_below_10_years_prct)
# class(scores$pop_10_to_64_years_prct)
# summary(scores$pop_10_to_64_years_prct)
# class(scores$elderly_above_64_years_prct)
# summary(scores$elderly_above_64_years_prct)
# 
# # 5 - CES Race
# class(scores$white_prct)
# summary(scores$white_prct)
# class(scores$hispanic_prct)
# summary(scores$hispanic_prct)
# class(scores$african_american_prct)
# summary(scores$african_american_prct)
# class(scores$native_american_prct)
# summary(scores$native_american_prct)
# class(scores$asian_american_prct)
# summary(scores$asian_american_prct)
# class(scores$`other/multiple_prct`)
# summary(scores$`other/multiple_prct`)
# 
# # 6 - CHHS Asthma
# class(asthma$year)
# summary(asthma$year)
# class(asthma$`age-adjusted_ed_visit_rate`)
# summary(asthma$`age-adjusted_ed_visit_rate`)
# # also include county

```

## Milestone #3 Summary

In Milestone #3, we finished subetting and cleaning the data, as well as identified any missing variables. We also converted the census tract-level data into county averages so that the data analysis can be done at the county level. We added variables regarding different categories of race and age, as we hoped that the analysis of racial disparities or age-related disparities can provide good evidence for any environmental health interventions to be formed in the near future.

```{r subset, include=FALSE}

# subset asthma data set by year 2020
asthma_2020 <- subset(asthma, year == 2020)

```

```{r more_cleaning_and_missing_values, include=FALSE}
# convert census tract in two datasets from integer to character
class(measures$census_tract)
measures$census_tract <- as.character(measures$census_tract)
class(measures$census_tract)
class(scores$census_tract)
scores$census_tract <- as.character(scores$census_tract)
class(scores$census_tract)

# identify missing values in the three datasets
asthma_missing <- colSums(is.na(asthma))
print(asthma_missing)
measures_missing <- colSums(is.na(measures))
print(measures_missing)
scores_missing <- colSums(is.na(scores))
print(scores_missing)

# what is the proportion of missing values in each dataset?
# https://thomasadventure.blog/posts/r-count-na/
mean(is.na(asthma))
mean(is.na(measures))
mean(is.na(scores))

# rename any more columns as needed
scores <- scores %>%
  rename(other_multiple_prct = `other/multiple_prct`)

```

```{r population_numbers, include=FALSE}
# change race and age percentages to population numbers, round to whole numbers
scores$children_below_10_years_num <- round(scores$total_population * scores$children_below_10_years_prct)
scores$pop_10_to_64_years_num <- round(scores$total_population * scores$pop_10_to_64_years_prct)
scores$elderly_above_64_years_num <- round(scores$total_population * scores$elderly_above_64_years_prct)
scores$hispanic_num <- round(scores$total_population * scores$hispanic_prct)
scores$white_num <- round(scores$total_population * scores$white_prct)
scores$african_american_num <- round(scores$total_population * scores$african_american_prct)
scores$native_american_num <- round(scores$total_population * scores$native_american_prct)
scores$asian_american_num <- round(scores$total_population * scores$asian_american_prct)
scores$other_multiple_num <- round(scores$total_population * scores$other_multiple_prct)

# round to 2 decimal points for CES scores and percentiles
scores$ces_4.0_score_round <- round(scores$ces_4.0_score, digits = 2)
scores$ces_4.0_percentile_round <- round(scores$ces_4.0_percentile, digits = 2)

# pivoting is not needed for these datasets at this time


```

```{r new_variables, include=FALSE}
#combining CES scores into a county level measure

scores_raw_county <- scores_raw %>%
  replace(is.na(.),0) %>%
  select(-c(`CES 4.0 Percentile Range`,`CES 4.0 Percentile`, `Census Tract`)) %>%
  group_by(County) %>% 
  summarize_all(mean) %>%
#lumping together non-white percentages in population
  mutate(non_white_prct =`Hispanic prct`+`African American prct`+`Native American prct`+`Asian American prct`+`Other/Multiple prct`) %>%
#calculating non-white population
  mutate(non_white_pop = `non_white_prct`/100 * `Total Population`) %>%
#calculating white population
  mutate(white_pop = `White prct`/100 * `Total Population`) %>%
  rename(white_prct =`White prct`) %>%
#removing individual race categories for non-white individuals
  select(-c(`Hispanic prct`,`African American prct`,`Native American prct`,`Asian American prct`,`Other/Multiple prct`)) %>%
#calculating population of children below 10 years
  mutate(pop_under_10 = `Children below 10 years prct`/100*`Total Population`) %>%
  rename(pop_under_10_prct = `Children below 10 years prct`) %>%
#calculating population of individuals above 10 years
  mutate(pop_over_10_prct = `Pop 10 to 64 years prct` + `Elderly above 64 years prct`) %>%
  mutate(pop_over_10 = `pop_over_10_prct`/100 * `Total Population`) %>%
#removing sub-categories of individuals over 10 years
  select(-c(`Pop 10 to 64 years prct`,`Elderly above 64 years prct`))

```

We re-calculated the quartiles for the CES datasets, now based on county data instead of census tract data. We filtered, stratified, and created datasets based on our exposures of interest: age (child vs. adult), race (White vs. Non-White), and also summarized means of two CES measures of interest (Pollution and Housing Burden).

```{r quartiles_and_score_ordering, include=FALSE}
 
#calculating quartiles for county CES scores
CES_score_quartile <- quantile(scores_raw$`CES 4.0 Score`, na.rm=TRUE)

scores_raw_county <- scores_raw_county %>%
  mutate(CES_score_quartile_range = cut(`CES 4.0 Score`, breaks = c(-Inf, 14.786523, 25.553718, 40.057395, Inf),
                                        labels = c("Lowest Quartile","Second Quartile","Third Quartile", "Fourth Quartile"))) %>%

#subsetting and ordering the scores dataset
   select(c(`County`, `CES 4.0 Score`, `CES_score_quartile_range`, `Total Population`, `white_prct`, `white_pop`, `non_white_prct`, `non_white_pop`, `pop_under_10_prct`, 
           `pop_under_10`,`pop_over_10_prct`, `pop_over_10`))

scores_raw_county <- scores_raw_county[order(scores_raw_county$County),]
scores_raw_county$County <- toupper(scores_raw_county$County)

```

```{r recode_invalid_measures_and_sum_county_means, include=FALSE}
#recoding invalid values in the measures file
#then summarizing means of county measures (Pollution/Housing Burden)
measures_raw_county <- measures_raw %>%
  replace(is.na(.),0) %>%
  group_by(`California County`) %>%
  summarize_all(mean) %>%
  select(c(`California County`,`Pollution Burden`,`Pollution Burden Score`, `Pollution Burden Pctl`, `Housing Burden`, `Housing Burden Pctl`))
  
measures_raw_county <- measures_raw_county[order(measures_raw_county$`California County`),]
colnames(measures_raw_county)[colnames(measures_raw_county)== "California County"] = "County" 
measures_raw_county$County <- toupper(measures_raw_county$County)
measures_raw_county <- measures_raw_county %>% mutate(County=paste(County,c("COUNTY"), sep=" "))

```

```{r recode_invalid_asthma_and_age_stratify, include=FALSE}
#recoding invalid values for asthma dataset
#grouping values by county
asthma_2020 <- asthma %>%
  replace(is.na(.),0) %>%
  group_by(county) %>%
  filter(year>=2020)
  #select(-c(`age-adjusted_ed_visit_rate`, `year`))

#filtering asthma dataset to stratify by age
#create two datasets - one for child, one for adult
asthma_2020_age <- asthma_2020 %>% filter(strata =="Child vs. adult")

asthma_2020_age_adult <- filter(asthma_2020_age, strata_name == "18+ years")
asthma_2020_age_adult <- asthma_2020_age_adult[-(1),]
asthma_2020_age_adult <- asthma_2020_age_adult[order(asthma_2020_age_adult$county),]
colnames(asthma_2020_age_adult)[colnames(asthma_2020_age_adult)== "county"] = "County" 
asthma_2020_age_adult <- asthma_2020_age_adult %>% mutate(County=paste(County,c("COUNTY"), sep=" ")) %>%
  select(c("County","number_of_ed_visits", "age-adjusted_ed_visit_rate")) %>%
  rename(adult_asthma_ed_visits = "number_of_ed_visits")

asthma_2020_age_child <- asthma_2020_age[-(60:118),]
asthma_2020_age_child <- asthma_2020_age_child[-(1),]
asthma_2020_age_child <- asthma_2020_age_child[order(asthma_2020_age_child$county),]
colnames(asthma_2020_age_child)[colnames(asthma_2020_age_child)== "county"] = "County" 
asthma_2020_age_child <- asthma_2020_age_child %>% mutate(County=paste(County,c("COUNTY"), sep=" "))%>%
  select(c("County","number_of_ed_visits", "age-adjusted_ed_visit_rate")) %>%
  rename(child_asthma_ed_visits = "number_of_ed_visits")



#filtering asthma dataset to stratify by race
#create two datasets - one for white, one for non-white
#summarizing number of ED visits for white and non-white individuals by county

asthma_2020_race <- asthma_2020 %>%
  filter(strata == "Race/ethnicity")

asthma_2020_white <- asthma_2020_race %>%
  filter(strata_name == "White")
asthma_2020_white <- asthma_2020_white[-(1),]
asthma_2020_white <- asthma_2020_white[order(asthma_2020_white$county),]
colnames(asthma_2020_white)[colnames(asthma_2020_white)== "county"] = "County" 
asthma_2020_white <- asthma_2020_white %>% mutate(County=paste(County,c("COUNTY"), sep=" "))%>%
  select(c("County","number_of_ed_visits")) %>%
  rename(white_asthma_ed_visits = "number_of_ed_visits")


asthma_2020_non_white <- asthma_2020_race %>%
  filter(strata_name != "White")
asthma_2020_non_white <- asthma_2020_non_white[-(1),]
asthma_2020_non_white <- asthma_2020_non_white[order(asthma_2020_non_white$county),]
asthma_2020_non_white <- asthma_2020_non_white %>%
  group_by(county) %>%
  summarise(num = n(),
            non_white = sum(number_of_ed_visits))
asthma_2020_non_white <- asthma_2020_non_white[-(6),]
colnames(asthma_2020_non_white)[colnames(asthma_2020_non_white)== "county"] = "County" 
asthma_2020_non_white <- asthma_2020_non_white %>% mutate(County=paste(County,c("COUNTY"), sep=" "))%>%
  select(c("County","non_white")) %>%
  rename(non_white_asthma_ed_visits = "non_white")


```

```{r join_scores_with_measures_and_asthma Kathy 5, include=FALSE}
#joining the scores with measures and stratified asthma datasets

CES_environment_Asthma <- scores_raw_county %>%
   left_join(measures_raw_county, by='County') %>%
   left_join(asthma_2020_age_adult, by="County") %>% 
   left_join(asthma_2020_age_child, by="County") %>%
   left_join(asthma_2020_white, by="County") %>%
   left_join(asthma_2020_non_white, by="County")
```

We created a new data dictionary with terms and definitions of variables used in our analysis. Due to feedback, we will update our data dictionary code to be more comprehensive.

```{r data_dictionary_original - Kathy, include=FALSE}

library(kableExtra)

new_data_dictionary <- data.frame(
variables <- c('2020 Asthma ED visits, 2019 Census, and environmental burden summary','County', 'CES 4.0 Score', 'CES_score_quartile_range', 'Total Population', 'white_prct', 'white_pop',
               'non_white_prcp', 'non_white_pop', 'pop_under_10_prct', 'pop_under_10', 'pop_over_10_prct','pop_over_10',
               'Pollution Burden', 'Pollution Burden Score','Pollution Burden Pctl', 'Housing Burden', 'Housing Burden Pctl',
               'adult_asthma_ed_visits','child-asthma_ed_visits','white_asthma_ed_visits','non_white_asthma_ed_visits','AI/AN','NHPI'), 
descriptions <- c('Data dictionary','California counties', 'CalEnviroScreen Score','CES 4.0 score grouped by quartile range of scores', '2019 ACS population estimates in census tracts', 'percetange of population that identify as white', 'estimated raw number of population that identify as white, calculated by multiplying percentage to total population', 'percentage of population that identify as non-white or multiple race, calculated by summming percentages of all non-white races and others/multile race from raw demographic results in census tract', 'estimated raw number of population that identify as non-white or multiple race, calculated by multiplying percentage to total population', 'percentage of population that is less than 10 years old','estimated raw number of population that is less than 10 years old, calculated by multiplying percentage to total populaiton', 'percentage of population that is more than 10 years old, calculated by summing population 10 to 64 years and over 64 years', 'estimated raw number of population that is more than 10 years old, calculated by multiplying percentage to total population','Average of percentiles from the Pollution Burden indicators (with a half weighting for the Environmental Effects indicators)','Pollution Burden variable scaled with a range of 0-10. (Used to calculate CES 4.0 Score)','Pollution burden percentile','Percent housing burdened low income households', 'Housing burden percentile','number of ED visits due to asthma for those over 18 years of age', 'number of ED visits due to asthma for those under 18 years of age', 'number of ED visits due to asthma for those that identify as white', 'number of ED visits due to asthma for those that identify as non-white or multiple race','American Indian/Alaskan Native','Native Hawaiian/Pacific Islander'))

colnames(new_data_dictionary)[1] = "VARIABLE"
colnames(new_data_dictionary)[2] = "DESCRIPTION"

new_data_dictionary <- new_data_dictionary %>% 
  kbl () %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, width = "30em")

new_data_dictionary


```

We analyzed county-level CES scores, Pollution Burden Score, and Housing Burden Percentage. We then looked at age and asthma rates, comparing the rates for adults and children, and then using the proportions to calculate the weighted state ED admission rates for adults and children. The final tables of our analysis are included below.

```{r ces_scores_measures_analysis, include=FALSE}

#3A: County and: CES score, Pollution Burden, Housing Burden %

#subsetting the combined dataset to analyze statistics for specific environmental measures by county 

asthma_house_poll <- data.frame("County" = CES_environment_Asthma$County, 
                                "CES 4.0 Score" = 
                                  CES_environment_Asthma$`CES 4.0 Score`, 
                                "Pollution Burden Score" = 
                                CES_environment_Asthma$`Pollution Burden Score`, 
                                "Housing Burden %" = 
                                  CES_environment_Asthma$`Housing Burden`, 
                                "Population" = 
                                  CES_environment_Asthma$`Total Population`)

colnames(asthma_house_poll) = c("County", "CES 4.0 Score", 
                                "Pollution Burden Score", 
                                "Housing Burden %", "Population")


#calculating the weighted averages for CES/pollution/housing

asthma_house_poll$weights <- 
  asthma_house_poll$`Population`/sum(asthma_house_poll$`Population`)

weighted_CES <-
  sum(asthma_house_poll$weights*asthma_house_poll$`CES 4.0 Score`)

weighted_pollution_burden <-
  sum(asthma_house_poll$weights*asthma_house_poll$`Pollution Burden Score`)

weighted_housing_burden <-
  sum(asthma_house_poll$weights*asthma_house_poll$`Housing Burden %`)

weighted_environment <- data.frame(weighted_CES, weighted_pollution_burden, weighted_housing_burden)

colnames(weighted_environment) = c("Weighted CES 4.0 Score", 
                                   "Weighted Pollution Burden", 
                                   "Weighted Housing Burden %")

```

```{r age_and_asthma_rates, include=FALSE}

#joining the child and adult asthma ED admission datasets

asthma_2020_age_report <- asthma_2020_age_adult %>%
   left_join(asthma_2020_age_child, by='County')

#calculating the weighted state ED admission rate for adult and child
adult_total_ed_visits <- sum(asthma_2020_age_report$adult_asthma_ed_visits)
child_total_ed_visits <- sum(asthma_2020_age_report$child_asthma_ed_visits)

#defining a column that represents the proportion of adult/child ED admissions contributed by county 

asthma_2020_age_report$adult_visit_state_prop <- 
  asthma_2020_age_report$adult_asthma_ed_visits/adult_total_ed_visits 

asthma_2020_age_report$child_visit_state_prop <- 
  asthma_2020_age_report$child_asthma_ed_visits/child_total_ed_visits 

#using above proportion to calculate weighted state ED admission rates for adult and child
adult_weighted_state_ed_rate <- 
  sum(asthma_2020_age_report$adult_visit_state_prop*
        asthma_2020_age_report$`age-adjusted_ed_visit_rate.x`)

child_weighted_state_ed_rate <- 
  sum(asthma_2020_age_report$child_visit_state_prop*
        asthma_2020_age_report$`age-adjusted_ed_visit_rate.y`)

#cleaning up the calculation worksheet, asthma_2020_age_report
asthma_2020_age_final <- select(asthma_2020_age_report, 
                                "age-adjusted_ed_visit_rate.x", 
                                "age-adjusted_ed_visit_rate.y")
colnames(asthma_2020_age_final) = c("County",
                                    "Adult Age-Adjusted ED Visit Rate", 
                                    "Child Age-Adjusted ED Visit Rate")


```

```{r statistics_and_tables, include=FALSE}
#joining the cleaned up CES data with the cleaned up age-asthma data in preparation for summary statistics and tables

data_final <- asthma_2020_age_final %>%
   left_join(asthma_house_poll, by='County')
data_final <- data_final[,-c(7,8)]

#summary statistics for the CES/age-asthma data
print(summary(data_final))

adult_quartile <- quantile(data_final$`Adult Age-Adjusted ED Visit Rate`, probs = c(0.25,0.5,0.75,1))
child_quartile <- quantile(data_final$`Child Age-Adjusted ED Visit Rate`, probs = c(0.25,0.5,0.75,1))
ces_quartile <- quantile(data_final$`CES 4.0 Score`, probs = c(0.25,0.5,0.75,1))
pollution_quartile <- quantile(data_final$`Pollution Burden Score`, probs = c(0.25,0.5,0.75,1))
housing_quartile <- quantile(data_final$`Housing Burden %`, probs = c(0.25,0.5,0.75,1))

quartiles <- data.frame(adult_quartile,child_quartile,ces_quartile,pollution_quartile,housing_quartile)
colnames(quartiles) = c("Quartiles of CA County Adult ED Admission Rate", "Quartiles of CA County Child ED Admission Rate", "Quartiles of CA County CES 4.0 Scores", "Quartiles of CA County Pollution Burden Scores", "Quartiles of CA County Housing Burden %")

#weighted average table
weighted_final <- data.frame(adult_weighted_state_ed_rate, 
                             child_weighted_state_ed_rate, 
                             weighted_CES, weighted_pollution_burden, 
                             weighted_housing_burden)

colnames(weighted_final) <-
  c("Adult Weighted State ED Admission Rate",
    "Child Weighted State ED Admission Rate",
    "Weighted State CES",
    "Weighted State Pollution Burden",
    "Weighted State Housing Burden %")

rownames(weighted_final) <- c("Weighted Value")

print(t(quartiles))
print(t(weighted_final))


```

We attempted to analyze the asthma ED visit rates by race but ran into issues due to the year mismatch between the datasets. We found that there were certain values where the non-white asthma visit rates were larger than the non-white population of the county, and may need to revise our plan of race-focused analysis.

```{r race_asthma_analysis, include=FALSE}

#need some work on race for final submission

# #3C: obtain the race populations from CES_Environment_asthma, and divide the ED visits in asthma_2020 white and non-white by this population. note that we assume that the racial populations in each county don't change much year-over-year. This is a third table. column 1 is county, column 2 is racial group, column 3 is rate
# 
# #report out summary ed visits for: white, non-white
# 
# asthma_race_report <- select(CES_environment_Asthma, "County", "white_pop", "white_asthma_ed_visits", "non_white_pop", "non_white_asthma_ed_visits")
# 
# white_total_ed_visits <- sum(asthma_race_report$white_asthma_ed_visits)
# non_white_total_ed_visits <- sum(asthma_race_report$non_white_asthma_ed_visits)
# 
# 
# asthma_race_report$white_visit_state_prop <- asthma_race_report$white_asthma_ed_visits/white_total_ed_visits 
# 
# asthma_race_report$non_white_visit_state_prop <- asthma_race_report$non_white_asthma_ed_visits/non_white_total_ed_visits 
# 
# 
# asthma_race_report$white_asthma_ed_rate <- asthma_race_report$white_asthma_ed_visits/asthma_race_report$white_pop 
# asthma_race_report$non_white_asthma_ed_rate <- asthma_race_report$non_white_asthma_ed_visits/asthma_race_report$non_white_pop
# 
# white_weighted_state_ed_rate <- sum(asthma_race_report$white_visit_state_prop*asthma_race_report$white_asthma_ed_rate)
# 
# non_white_weighted_state_ed_rate <- sum(asthma_race_report$non_white_visit_state_prop*asthma_race_report$non_white_asthma_ed_rate)
# 
# asthma_race_final <- select(asthma_race_report, County, white_asthma_ed_rate, non_white_asthma_ed_rate)

```

We observed three limitations during our data analysis: #1 there is a year mismatch between CES data (2021) and CHHS data (2022), #2: we may have oversimplified the conversion of census tract data into county-level data through our method of using averages, and #3: the "asthma" dataset's age groups do not match 1:1 the CES' groupings. As we continue our analysis, we will keep these limitations in mind and do our best to mitigate any issues that may arise.

## Milestone #4 Code

### Data Dictionary Update

Narrative: We have updated our data dictionary code to be more comprehensive...

```{r data_dictionary_updated - Kathy}

library(kableExtra)

new_data_dictionary <- data.frame(
variables <- c('2020 Asthma ED visits, 2019 Census, and environmental burden summary','County', 'CES 4.0 Score', 'CES_score_quartile_range', 'Total Population', 'white_prct', 'white_pop',
               'non_white_prcp', 'non_white_pop', 'pop_under_10_prct', 'pop_under_10', 'pop_over_10_prct','pop_over_10',
               'Pollution Burden', 'Pollution Burden Score','Pollution Burden Pctl', 'Housing Burden', 'Housing Burden Pctl',
               'adult_asthma_ed_visits','child-asthma_ed_visits','white_asthma_ed_visits','non_white_asthma_ed_visits','AI/AN','NHPI'), 
descriptions <- c('Data dictionary','California counties', 'CalEnviroScreen Score','CES 4.0 score grouped by quartile range of scores', '2019 ACS population estimates in census tracts', 'percetange of population that identify as white', 'estimated raw number of population that identify as white, calculated by multiplying percentage to total population', 'percentage of population that identify as non-white or multiple race, calculated by summming percentages of all non-white races and others/multile race from raw demographic results in census tract', 'estimated raw number of population that identify as non-white or multiple race, calculated by multiplying percentage to total population', 'percentage of population that is less than 10 years old','estimated raw number of population that is less than 10 years old, calculated by multiplying percentage to total populaiton', 'percentage of population that is more than 10 years old, calculated by summing population 10 to 64 years and over 64 years', 'estimated raw number of population that is more than 10 years old, calculated by multiplying percentage to total population','Average of percentiles from the Pollution Burden indicators (with a half weighting for the Environmental Effects indicators)','Pollution Burden variable scaled with a range of 0-10. (Used to calculate CES 4.0 Score)','Pollution burden percentile','Percent housing burdened low income households', 'Housing burden percentile','number of ED visits due to asthma for those over 18 years of age', 'number of ED visits due to asthma for those under 18 years of age', 'number of ED visits due to asthma for those that identify as white', 'number of ED visits due to asthma for those that identify as non-white or multiple race','American Indian/Alaskan Native','Native Hawaiian/Pacific Islander'))

colnames(new_data_dictionary)[1] = "VARIABLE"
colnames(new_data_dictionary)[2] = "DESCRIPTION"

new_data_dictionary <- new_data_dictionary %>% 
  kbl () %>%
  kable_paper(full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, width = "30em")

new_data_dictionary
```

### Final Dataset Preparation

Narrative of join and pivot

```{r final_join_and_pivot - Jaemie}

# Join all datasets together (Jaemie)
# look at asthma_2020_race: take each county will have an age-adjusted ED visit rate, and have several columns, one for each race; may need to pivot 
# Join it with data_final
# Calculate any remaining data elements needed for analysis
# Show code used to create joined dataset, but please do not print full data frame output (showing data structure with str() is okay)
```

## Visualizations

Quick introduction explaining we'll be doing visualizations based on variables of interest and asthma and/or CES score and how it will help us communicate our data analysis findings to others

### Tables

Table #1:

Three county-level tables were generated using a combination of California asthma and CES data. The first table looks at age-adjusted asthma ED visit rates for all ages for each county, stratified by race. To simplify the discussion, tables focused on the nine Bay Area counties were generated. Notably, there are several zeroes in this table in the Native Hawaiian/Pacific Islander and American Indian/Alaskan Native columns. A possible explanation for this observation is that there may be little to no data on these populations in certain counties. Comparing across strata, we see that non-White, non-Asian/Pacific Islander racial groups have higher age-adjusted ED visit rates across all nine Bay Area counties. Further analysis could be performed to address this variation. One possible explanation could be geographic segregation where non-White and non-Asian/Pacific Islander groups live in areas that have more environmental hazards and pollution. We assessed pollution burden scores and housing burden % as proxies for environmental hazards at the county level. It may be valuable as a follow-up to assess the relationship between census tract racial composition to pollution burden and housing burden. This could help us investigate more clearly the relationship between race and environmental hazard exposure. If we assume causality between environmental hazard exposure (pollution burden and housing burden) to age-adjusted asthma ED visit rate, we could account for the variation seen across races in age-adjusted asthma ED visit rates.

In this project, our group wanted to analyze environmental factors by county by way of pollution burden scores and housing burden % in the California 2021 CES data. Notably, Marin and Sonoma counties exceed its Bay Area peers in CES Score and pollution burden but have a higher percentage of their populations that is housing burdened. Napa County, by contrast, had the median CES score but also had the lowest percentage of population that is housing burdened. Solano County has the worst CES score in the Bay Area and is in the upper quartile of housing burden population. Alameda and Contra Costa Counties have similar scores across all three metrics.

We also wanted to see if there were differences in age-adjusted asthma ED visit rates between adults and children across counties. Generally, adults appear to have slightly higher age-adjusted asthma ED visit rates but what is more interesting is that the county level effect seems to be stronger than age. Solano County, for example, has higher age-adjusted asthma ED visit rates for adults than for children but the magnitude of both rates are significantly higher than the rest of the Bay Area. Putting all three tables together, there appears to be significant variation in age-adjusted asthma ED visit rates across counties and racial categories. One possible explanation could be that county is a proxy for race. A future analysis should attempt to correlate census tract-level racial composition data to both pollution burden and age-adjusted asthma ED visit rates. 
```{r table_1_variables_of_interest - Vig, echo = TRUE}

# Variables of Interest by County: Pollution Scores, Housing Burden, CES Scores, and Asthma rates (all ages, all races, by county). 
# Can filter for Bay Area counties in the final table, as a sample, so that the table isn't too long when we print it
# San Francisco Bay Area region includes Alameda, Contra Costa, Marin, Napa, San Francisco, San Mateo, Santa Clara, Solano, and Sonoma counties

asthma_race_white <- filter(asthma_2020_race, strata_name == "White") %>%
  pivot_wider(names_from = "strata_name", values_from = "age-adjusted_ed_visit_rate") %>%
  select(county, White)

asthma_race_black <- filter(asthma_2020_race, strata_name == "Black")%>%
  pivot_wider(names_from = "strata_name", values_from = "age-adjusted_ed_visit_rate") %>%
  select(county, Black)
asthma_race_hispanic <- filter(asthma_2020_race, strata_name == "Hispanic") %>%
  pivot_wider(names_from = "strata_name", values_from = "age-adjusted_ed_visit_rate") %>%
  select(county, Hispanic)
asthma_race_AAPI <- filter(asthma_2020_race, strata_name == "Asian/PI") %>%
  pivot_wider(names_from = "strata_name", values_from = "age-adjusted_ed_visit_rate") %>%
  select(county, "Asian/PI")
asthma_race_AI <- filter(asthma_2020_race, strata_name == "AI/AN") %>%
  pivot_wider(names_from = "strata_name", values_from = "age-adjusted_ed_visit_rate") %>%
  select(county, "AI/AN")
asthma_race_NHPI <- filter(asthma_2020_race, strata_name == "NHPI") %>%
  pivot_wider(names_from = "strata_name", values_from = "age-adjusted_ed_visit_rate") %>%
  select(county, NHPI)
asthma_race_MR <- filter(asthma_2020_race, strata_name == "Multi-race") %>%
  pivot_wider(names_from = "strata_name", values_from = "age-adjusted_ed_visit_rate") %>%
  select(county, "Multi-race")

reduced <- Reduce(function(...) merge(..., by='county', all.x=TRUE), 
                  list(asthma_race_white,asthma_race_black,asthma_race_hispanic,
                       asthma_race_AAPI,asthma_race_AI,
                       asthma_race_NHPI, asthma_race_MR))

data_final_tojoin <- data_final %>% mutate(County = str_remove_all(County, " COUNTY")) %>% 
  rename(county = County)

data_final_with_race <- inner_join(reduced, data_final_tojoin, by = "county")
race_data_state <- filter(reduced, county == 'CALIFORNIA')

data_report <- filter(data_final_with_race, county %in% c("ALAMEDA","CONTRA COSTA", "SAN FRANCISCO", "MARIN", "NAPA", "SONOMA", "SOLANO", "SAN MATEO", "SANTA CLARA")) %>% rename(County = county, "Asian/Pacific Islander" = "Asian/PI", "American Indian/Alaskan Native" = "AI/AN", "Native Hawaiian/Pacific Islander" = NHPI)



race_report <- select(data_report, County, White, Black, Hispanic, "Asian/Pacific Islander", "American Indian/Alaskan Native", "Native Hawaiian/Pacific Islander", "Multi-race") %>% 
  kable(booktabs=T, align='lccccccc', caption="California All-Ages Asthma Age-Adjusted ED Visit Rate by Race and County, 2020",format.args=list(big.mark=","))

age_report <- select(data_report, County, "Adult Age-Adjusted ED Visit Rate", "Child Age-Adjusted ED Visit Rate") %>% 
  kable(booktabs=T, align='lcc', caption="California Adult (18+) vs. Child (0-17) Age-Adjusted ED Visit Rate by County, 2020",format.args=list(big.mark=","))

CES_report <- select(data_report, County, "CES 4.0 Score", "Pollution Burden Score", "Housing Burden %") %>% 
  kable(booktabs=T, align='lccc', caption="California CES 4.0 Scores, Pollution Burden Scores, Housing Burden % of Population by County, 2021",format.args=list(big.mark=","))


race_report
age_report
CES_report

```

Table #2 narrative and interpretation

In this table, we wanted to see how the nine Bay Area counties compare to the state weighted average CES Score. We see that all counties, except for Solano County, have lower CES Scores than the state as a whole. Looking at the raw data, we see significantly higher CES scores outside of the Bay Area. As noted previously, Marin and Sonoma Counties have very good CES scores and are significantly below the state weighted CES average score.

```{r table_2_ces_prct_diff - Vig, echo = TRUE}

# County CES: percentage difference between state-weighted and county for CES scores. Final table is the nine Bay area counties
# San Francisco Bay Area region includes Alameda, Contra Costa, Marin, Napa, San Francisco, San Mateo, Santa Clara, Solano, and Sonoma counties

ces_diff <- data.frame(County = data_report$County, ces_4 = data_report$`CES 4.0 Score`)
ces_diff$prct_vs_state <-(100*ces_diff$ces_4/weighted_CES)
colnames(ces_diff) <- c("County", "CES 4.0 Score", "% of weighted CA State CES Score")

kable(ces_diff, align='lcc', caption="California All-Ages Asthma ED Visit Rate by County in 2020, % of weighted CA State CES Score",format.args=list(big.mark=","))
```

### Charts

How each county differs from the weighted average for [variable] -- include statewide average so counties can benchmark against it.

Chart #1 narrative and interpretation

```{r chart_1_scatterplot_pollution_vs_asthma - Jaemie, echo = TRUE}

# Scatterplot - Pollution Burden vs. Asthma ED Rates (Jaemie)
```

Chart #2 narrative and interpretation

```{r chart_2_scatterplot_housing_vs_asthma - Jaemie, echo = TRUE}

# Scatterplot - Housing Burden vs. Asthma ED Rates (Jaemie)
```

Chart #3 narrative and interpretation

In order to create the box plot, outliers were eliminated. The general trend appears to show overall more ED visits in adults (>18 years of age) than that of children (0-17 years of age).

```{r chart_3_box_plot_adults_vs_children_asthma - Kathy, echo = TRUE}

asthma_2020_adult_vs_child <- asthma_2020_age[-c(1,60),]
asthma_2020_adult_vs_child$age_group[asthma_2020_adult_vs_child$age_group != "18+ years"] <- "0 to 17 years"

library(ggplot2)

boxplot <- ggplot(asthma_2020_adult_vs_child, aes(x=age_group, y=number_of_ed_visits, fill = age_group)) +
  geom_boxplot(outlier.shape = NA) +
  coord_cartesian(ylim=c(0,3000))+
  geom_jitter(position=position_jitter(0.2))+
  ggtitle("Comparison of Emergency Department Visits 
          between Children and Adults Across all California Counties") +
  xlab("Number of ED visits") +
  ylab("Age Group")
  
boxplot

  # Box Plot - Asthma ED Rates by County: Adults vs. Children (Kathy)
```

Chart #4 narrative and interpretation

Based on the comparison chart, the race that appears to be disporpotionally effected by asthma to a point of requiring emergency department visits are hispanic followed by black. 

```{r chart_4_bar_race_vs_asthma - Kathy, echo = TRUE}

bar_race_asthma <- ggplot(asthma_2020_race, aes(x=strata_name, y=number_of_ed_visits) ) +
  geom_bar(stat="identity") +
  ggtitle("Number of ED visits by Race") +
  xlab("Race") +
  ylab("Number of ED visits")  

bar_race_asthma

```

## Conclusion

Narrative -- we hope these visualizations will help us communicate the relationship between asthma and environmental factors, so that the data can be used to inform public health interventions in CA and reduce health disparities among age and race...
